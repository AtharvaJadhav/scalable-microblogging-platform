name: Combined CI/CD Pipeline

on:
  push:
    branches: [ main_CICD, main ]
  pull_request:
    branches: [ main_CICD, main ]

jobs:
  server-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'
      - name: Install server dependencies
        run: npm install
        working-directory: ./server

  web-build:
    needs: server-build-and-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'
      - name: Install web dependencies
        run: npm install
        working-directory: ./web
    
    build-and-push-docker:
      needs: web-build-and-test
      runs-on: ubuntu-latest
      # needs: build-and-push-backend
      steps:
        - uses: actions/checkout@v2
        - name: Build and Push Frontend Docker Image
          uses: mr-smithers-excellent/docker-build-push@v6
          with:
            image: purvil1699/docker-image
            tags: latest
            registry: docker.io
            dockerfile: ./web/Dockerfile
            username: purvil1699
            password: D@mkp@1699
